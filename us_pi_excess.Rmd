---
title: "Estimating the early death toll of COVID-19 in the United States"
author: "Dan Weinberger"
date: "5/1/2020"
output:
  html_document:
    df_print: paged
    html_document: null
    toc: yes
    toc_depth: 2
    toc_float: yes
  word_document:
    toc: yes
    toc_depth: '2'
  pdf_document: 
    keep_tex:  true
params:
  agg.level: 'state_region'
  n.days.filter: 20
  web.version: FALSE
  extrap.date: '2020-01-26'
  count.start.date: '2020-03-01'
  end.data.date: '2020-04-11'
---

```{r, include = F}
knitr::opts_chunk$set(
  collapse = TRUE,
  echo=F,
  warning=FALSE, 
  message=FALSE,
  comment = "#>",
  dev=c('png','pdf'),
  fig.path='./figures/'
)

extrap.date <-  as.Date(params$extrap.date)
count.start.date <- as.Date(params$count.start.date)
end.data.date <- as.Date(params$end.data.date)

state.name2 <- c(state.name, 'District of Columbia','Puerto Rico', 'United States', 'New York City')
state.abb2 <- c(state.abb, 'DC','PR','US','NYC')

last.date.format <- 
  format(end.data.date, '%b %d, %Y')
```


```{r, eval=F}
if (!require("devtools")) {
  install.packages("devtools")
}
devtools::install_github("weinbergerlab/ExcessILI")
```

```{r setup}
library(ExcessILI)
library(cdcfluview)
library(reshape2)
library(ggplot2)
library(lubridate)
library(RColorBrewer)
library(plotly)
library(MMWRweek)
library(readr)
library(rjson)
library(htmlTable)
library(RSocrata)
library(pdftools)
library(readr)
library(abind)
library(gsubfn)
library(dplyr)
library(RCurl)
#library(jsonlite)
set.seed(123)
source('./functions/ts_plot_func.R')
source('./functions/format_table.R')

```

```{r archivfunc}
# Using ExcessILI's data archiving functions, returns the most recent copy of
# output obtained by running a function or formula \code{f}, unless this 
# copy doesn't exist or is older (by modification time) than \code{maxage}.
# In that case, \code{f} is run and the output is archived into the folder
# Data/'storeName' as an RDS file, using the function ExcessILI::storeRDS.
#
# @param storeName A string. The name of the folder to store output in
# @param f A function or formula taking no arguments. Formulas are coerced to
#   functions.
# @param maxage How old can any existing archived file be before \code{f} is 
#   called again?
runIfExpired <- function(storeName, f, maxage=hours(1000000)) {
  basepath <- "Data/"
  mostRecent <- mostRecentTimestamp(storeName, basepath=basepath)
  f <- rlang::as_function(f)
  
  runAndArchive <- function() {
    data <- f()
    storeRDS(data, storeName, basepath)
    data
  }
    
  if (is.na(mostRecent)) 
    return(runAndArchive())

  if (mostRecent %--% now() < maxage)
    return(retrieveRDS(storeName, basepath))

  runAndArchive()
}
```

```{r states_to_plot}
plot.states <- c('CA','TX','FL','NJ', 'NY','WA','IL','GA','MI','LA', 'MA' )

exclude.states <- c('CT', 'NC', 'PR') #no up-to-date number
#exclude.states <- c('')
```

```{r state_region_cw}
#cross walk file to map  states to hhs regions
#
hhs_states <- cdcfluview::hhs_regions
hhs_states$state <-
  state.abb2[match(hhs_states$state_or_territory, state.name2)]
hhs_states$state_region <- hhs_states$region

hhs_states$state_region[hhs_states$state %in% plot.states] <-
  hhs_states$state[hhs_states$state %in% plot.states]

hhs_states <- 
  hhs_states[, c('state', 'state_region')]

hhs_states$state_region <- 
  gsub(' ', '', hhs_states$state_region)

hhs_states.cw <-
  hhs_states[!is.na(hhs_states$state), ]

#Exclude CT
hhs_states.cw <-
  hhs_states.cw[!(hhs_states.cw$state %in% exclude.states), ]

if (params$agg.level == 'state_region') {
  hhs_states.cw.spl <- split(hhs_states.cw,
                             hhs_states.cw$state_region)
} else{
  hhs_states.cw.spl <- split(hhs_states.cw,
                             hhs_states.cw$state)
}

hhs_states.cw.spl <- lapply(hhs_states.cw.spl, function(x) {
  x$state_region.lab <- paste(x$state, collapse = ',')
  return(x)
})

hhs_states.cw <- do.call('rbind.data.frame', hhs_states.cw.spl)
hhs_states.cw$state_region[hhs_states.cw$state_region != hhs_states.cw$state] <-
  hhs_states.cw$state_region.lab[hhs_states.cw$state_region != hhs_states.cw$state]


```

```{r nrevs_format}
#download the NREVSS data

#ARCHIVE
nrevvs.state <- runIfExpired('nrevss_state', ~cdcfluview::who_nrevss(region = c("state")))
  
  clin <- nrevvs.state[["clinical_labs"]]
  clin$state <- state.abb2[match(clin$region, state.name2)]
  
  data(cdcfluview::hhs_regions)
  
  cw.file <- cdcfluview::hhs_regions
  
  clin2 <- merge(clin, hhs_states.cw,
                 by = "state")

  clin2 <- merge(clin2, cw.file,
                 by.x = "region",
                 by.y = "state_or_territory")
  
  clin2.subsetvars <- 
    c('region', 'region_number',
      'year', 'week', 'wk_date',
      'total_a','total_b',
      'total_specimens','state_region')
  
  clin2 <- clin2[, clin2.subsetvars]
  
  names(clin2)[1:2] <- c("state", "hhs_region")
  
  clin2$total_specimens <- as.numeric(clin2$total_specimens)
  clin2$total_a <- as.numeric(clin2$total_a)
  clin2$total_b <- as.numeric(clin2$total_b)
  
  clin2 <- aggregate(clin2[, c('total_specimens','total_a','total_b')], by=list('state'=clin2$state_region, 'wk_date'=clin2$wk_date,'hhs_region'=clin2$hhs_region), FUN=sum, na.rm=T)
  
  ##Florida doesn't have ILI data, so use regions ILI dat
  #
  #ARCHIVE
  nrevvs_hhs <- runIfExpired('nrevss_hhs', ~cdcfluview::who_nrevss(region = c("hhs")))
  
  clin.hhs <- nrevvs_hhs[["clinical_labs"]]
  clin.hhs.subsetvars <-
    c('region',
      'wk_date',
      "total_a",'total_b',
      'total_specimens')
  
  clin.hhs <- clin.hhs[, clin.hhs.subsetvars]
  clin.hhs$region <- as.numeric(gsub("Region ", "", clin.hhs$region))
  
  names(clin.hhs) <-
    c("hhs_region",
      "wk_date",
      "hhs_total_a",'hhs_total_b',
      'hhs_total_specimens')
  
  clin3 <- merge(clin2, clin.hhs,
                 by = c("hhs_region", "wk_date"))

  #If no specimens for state, use HHS region estimates
  clin3$total_specimens[clin3$total_specimens==0] <-
    clin3$hhs_total_specimens[clin3$total_specimens==0]
  
  clin3$total_a[clin3$total_a==0] <-
    clin3$hhs_total_a[clin3$total_a==0]
  
  clin3$total_b[clin3$total_b==0] <-
    clin3$hhs_total_b[clin3$total_b==0]
  
  clin3$total_specimens <- as.numeric(clin3$total_specimens)
  
  clin3$total_a <- as.numeric(clin3$total_a)
  clin3$total_b <- as.numeric(clin3$total_b)  
  
  clin3$flu_pct_adj <- (clin3$total_a + clin3$total_b)/clin3$total_specimens
  
   clin4<-clin3[,c('state','flu_pct_adj', 'wk_date')]

  clin4.lag1<-clin4
  clin4.lag1$wk_date <- clin4$wk_date + days(7)
  names(clin4.lag1) <-c('state','flu_pct_adj_lag1','wk_date')
  
  clin4.lag2<-clin4
  clin4.lag2$wk_date <- clin4$wk_date + days(14)
   names(clin4.lag2) <-c('state','flu_pct_adj_lag2','wk_date')
   
clin4.lags <- merge(clin4, clin4.lag1, by=c('state','wk_date'))
clin4.lags <- merge(clin4.lags, clin4.lag2, by=c('state','wk_date'))

  ##national flu data
nrevvs.natl <- runIfExpired('nrevss_national', ~cdcfluview::who_nrevss(region = c("national")))
nrevvs.natl <- nrevvs.natl$clinical_labs
nrevvs.natl <-
  nrevvs.natl[,c('wk_date','percent_positive') ]
names(nrevvs.natl) <- c('wk_date','flu_pct_adj')

natl.lag1 <- nrevvs.natl
natl.lag1$wk_date <- natl.lag1$wk_date +days(7)
names(natl.lag1) <- c('wk_date','flu_pct_adj_lag1')

natl.lag2 <- nrevvs.natl
natl.lag2$wk_date <- natl.lag2$wk_date +days(14)
names(natl.lag2) <- c('wk_date','flu_pct_adj_lag2')

nrevvs.natl <- merge(nrevvs.natl, natl.lag1, by='wk_date')
nrevvs.natl <- merge(nrevvs.natl, natl.lag2, by='wk_date')

nrevvs.natl$state <- 'US'

nrevvs.combo <-
  rbind.data.frame(nrevvs.natl,clin4.lags)
```

```{r import_state_pi_data}
#Import the P&I data from fluview--this is used to set the historical baseline; updated weekly

#ARCHIVE
pi.data <- runIfExpired('pi_mortality_state', ~pi_mortality(coverage_area='state'))

pi.data.last <- pi.data[pi.data$week_end==max(pi.data$week_end) & pi.data$geo_description=='State',]

last.date.avail.pi <- 
  max(pi.data$week_end)
last.date.obtained <- 
  last.date.avail.pi +6 #release date fr latest data (if            weekly)

 pi.data <- pi.data[pi.data$week_end <=                     (last.date.obtained-params$n.days.filter),]
 
pi.data <- pi.data[!(is.na(pi.data$week_end)),]

pi.data.not.miss.states <- unique(pi.data.last$region_name)

pi.data.not.miss.states <- state.abb2[match(pi.data.not.miss.states, state.name2)]

pi.data.not.miss.states <-
  pi.data.not.miss.states[!is.na(pi.data.not.miss.states)]


```

```{r import_cdc_covid_view}
#official CDC data, updated daily on P&I, covid, all deaths

#url.cdc.covid<-"https://data.cdc.gov/resource/hc4f-j6nb.json" #no longer being updated as of Apr 30

#Updated week days
url.cdc.covid <- "https://data.cdc.gov/resource/r8kw-7aab.json"
#ARCHIVE
cdc.data <- runIfExpired('cdc_covid_data', 
 ~jsonlite::read_json(url.cdc.covid, simplifyVector = T),maxage=hours(24))

names(cdc.data) <- 
  c('data_as_of','start_week', 'end_week', 'group', 'state','indicator','nchs.covid.deaths','nchs.total.deaths','percent_complete', 'nchs.pneu.death','nchs.pneum.w.covid','nchs.flu.death','nchs.pic')

cdc.data$start_week <- NULL

cdc.data$end_week <-
  as.Date(substr(cdc.data$end_week,1,10))

#Convert character to numeric
cdc.data[,c('nchs.covid.deaths','nchs.total.deaths','percent_complete', 'nchs.pneu.death','nchs.pneum.w.covid','nchs.flu.death','nchs.pic')] <- apply(cdc.data[,c('nchs.covid.deaths','nchs.total.deaths','percent_complete', 'nchs.pneu.death','nchs.pneum.w.covid','nchs.flu.death','nchs.pic')],2, as.numeric)

#cdc.summary.nat <-
#  cdc.data[cdc.data$state=='United States',]

cdc.summary.wk <- cdc.data

cdc.summary.wk <- cdc.summary.wk[, c('state', 'end_week' ,'nchs.covid.deaths','nchs.total.deaths','percent_complete', 'nchs.pneu.death','nchs.pneum.w.covid','nchs.flu.death','nchs.pic')]


```

```{r aggregate_fluview_deaths_natl}
##aggregate cdc fluview data to national-level (excluding exclusion states, to be used for national baseline)
pi.data.exclude <- pi.data

pi.data.exclude$state <-   
  state.abb2[match(pi.data.exclude$region_name, state.name2)]

pi.data.exclude <- 
  pi.data.exclude[!(pi.data.exclude$state %in% exclude.states),]

natl.pi.data <- 
  aggregate(pi.data.exclude[,c("total_pni", 'all_deaths')],
            by=list('week_end'=pi.data.exclude$week_end,
                'year_week_num'=pi.data.exclude$weeknumber ), FUN=sum)

natl.pi.data$state <- 'United States'
state.pi.data <-
  pi.data[,c('week_end','year_week_num','total_pni','all_deaths','region_name')]
names(state.pi.data) <- c('week_end','year_week_num','total_pni','all_deaths','state')

pi.data.combined <- 
  rbind.data.frame(state.pi.data, natl.pi.data)


```


```{r combine.cdc.data}
#Combine the fluview P&I data with the CDC's covid data
cdc.comb1 <- 
  merge(pi.data.combined,cdc.summary.wk, by.y=c('state','end_week'), by.x=c('state','week_end'), all=T)

#Filer dates after the specified end date
cdc.comb1 <- cdc.comb1[cdc.comb1$week_end <= end.data.date,]

cdc.comb1$year <- 
  year(cdc.comb1$week_end)

max.wk <- 
  as.numeric(unique(cdc.comb1$year_week_num[cdc.comb1$week_end==max(cdc.comb1$week_end, na.rm=T)])[1])

wk.range <- c(10,max.wk)

# NCHS data from api only available since late-Jan; fill in with historical data from fluview P&I data
cdc.comb1$all_deaths[!is.na(cdc.comb1$nchs.total.deaths)] <- 
  cdc.comb1$nchs.total.deaths[!is.na(cdc.comb1$nchs.total.deaths)]

cdc.comb1$nchs.pic[is.na(cdc.comb1$nchs.pic)] <-
  cdc.comb1$total_pni[is.na(cdc.comb1$nchs.pic)]

cdc.comb1$nchs.total.deaths[is.na(cdc.comb1$nchs.total.deaths)] <-
  cdc.comb1$all_deaths[is.na(cdc.comb1$nchs.total.deaths)]

cdc.comb1 <-
  cdc.comb1[order(cdc.comb1$state,cdc.comb1$week_end),]

```

```{r clean_pi_data1, include=F}

cdc.comb2 <- cdc.comb1

cdc.comb2$state <-
  state.abb2[match(cdc.comb2$state, state.name2)]

cdc.comb2 <- cdc.comb2[!(cdc.comb2$state %in% exclude.states),]

cdc.data.ny.separate <- cdc.comb2

cdc.comb2$state[cdc.comb2$state=='NYC'] <-'NY'

cdc.comb2 <- merge(cdc.comb2,hhs_states.cw, by='state', all=T)

cdc.comb2$state_region[cdc.comb2$state=='US'] <- 'US'

pi.data.agg <- aggregate(cdc.comb2[,c('total_pni','all_deaths','nchs.covid.deaths','nchs.total.deaths','nchs.pneu.death','nchs.pneum.w.covid','nchs.flu.death','nchs.pic')], by=list('state'=cdc.comb2$state_region,  'week_end'=cdc.comb2$week_end), FUN=sum, na.rm=T)

spl1<-split(pi.data.agg, pi.data.agg$state)
min.state <- lapply(spl1, function(x){ x$miss.x<-min(x$total_pni, na.rm=T)
return(x)
                })
pi.data.clean <- do.call('rbind.data.frame',min.state)
pi.data.clean <- pi.data.clean[!is.na(pi.data.clean$miss.x),]

pi.data.clean$nchs.total.deaths[pi.data.clean$week_end < as.Date('2020-02-01')] <-
  pi.data.clean$all_deaths[pi.data.clean$week_end < as.Date('2020-02-01')]

pi.data.clean$nchs.pic[pi.data.clean$week_end < as.Date('2020-02-01')] <-
  pi.data.clean$total_pni[pi.data.clean$week_end < as.Date('2020-02-01')]

nrevvs.combo$week_end <- nrevvs.combo$wk_date +days(6)

analysis.data <- merge(pi.data.clean, nrevvs.combo, by=c('state', 'week_end'), all=T)

analysis.data <-
  analysis.data[analysis.data$week_end <= end.data.date,]

analysis.data <- analysis.data[!is.na(analysis.data$flu_pct_adj_lag1),]

states.cdc <- unique(analysis.data$state)
states.cdc <- states.cdc[states.cdc!='US']

date.print <- max(analysis.data$week_end, na.rm=T)

```


```{r import_covid_tracking}
#TESTING DATA FORMATTING
url.test<-"https://covidtracking.com/api/v1/states/daily.json" 

#ARCHIVE
json_data <- runIfExpired('covidtracking_states_daily', ~fromJSON(file=url.test))
test.dates <- as.character(sapply(json_data,'[[','date'))

test.state <- sapply(json_data,'[[','state')
testN <- sapply(json_data, '[[', 'totalTestResultsIncrease')
testN <-sapply(testN, function(x){ 
  if(is.null(x)){
  x <-0
  }
  return(x)
  }
  )
deathN <- sapply(json_data, '[[', 'deathIncrease')
deathN <-sapply(deathN, function(x){ 
  if(is.null(x)){
  x <-0
  }
  return(x)
  }
  )
test.ds <- cbind.data.frame('state'=test.state,test.dates, 'testN.day'=testN, 'deathN.day'=deathN )
test.ds$test.date.wk <-floor_date(as.Date(test.ds$test.dates, '%Y%m%d'),'week')

test.ds <- merge(test.ds, hhs_states.cw, by='state')


test.ds.agg <- aggregate( test.ds[,c('testN.day','deathN.day')] , by=list('state'=test.ds$state_region,'date'=test.ds$test.date.wk), FUN=sum, na.rm=T)

names(test.ds.agg) <- c('state','date','testN','deathN')

pop1<-read.csv('./Data/nst-est2019-01.csv')
pop1$state_name <- substring(pop1$state_name,2)
pop1$state <- state.abb2[match(pop1$state_name, state.name2)]
pop1$census_bureau_pop_2019 <- gsub( ',', '',pop1$census_bureau_pop_2019)
pop1$census_bureau_pop_2019 <-as.numeric(pop1$census_bureau_pop_2019)

pop1.reg <- merge(pop1, hhs_states.cw, by='state')
pop2 <- aggregate(pop1.reg[,"census_bureau_pop_2019"], by=list('state'=pop1.reg$state_region), FUN=sum)
names(pop2) <- c('state','census_bureau_pop_2019')

test.ds2 <- merge(test.ds.agg, pop2, by='state')
test.ds2$test.week.per.capita <- test.ds2$testN/test.ds2$census_bureau_pop_2019*1000
names(test.ds2) <- c('state','date','testN','covid.track.death', 'pop2019',"test.week.per.capita")

test.ds3.spl <- test.ds2
```



### Mortality data on deaths due to pneumonia & influenza through the week ending `r  date.print`

Dan Weinberger,^1^  Jenny Chen,^7^ Ted Cohen,^1^  Forrest W. Crawford,^2^  Farzad Mostashari,^3^  Don Olson,^4^  Virginia E Pitzer,^1^  Nicholas G Reich,^5^  Marcus Russi,^1^ Lone Simonsen,^6^ Annie Watkins,^1^ Cecile Viboud^7^ 

^1^Department of Epidemiology of Microbial Diseases and the Public Health Modeling Unit, Yale School of Public Health, New Haven, CT
^2^Department of Biostatistics and the Public Health Modeling Unit, Yale School of Public Health, New Haven, CT; Yale Departments of Ecology and Evolutionary Biology, Statistics & Data Science, Yale School of Management
^3^Aledade, Inc
^4^Department of Health and Mental Hygiene, New York City, NY
^5^Department of Biostatistics and Epidemiology, School of Public Health and Health Sciences, University of Massachusetts, Amherst, MA
^6^Department of Science and Environment, Roskilde University, Denmark
^7^Division of International Epidemiology and Population Studies, Fogarty International Center, National Institutes of Health, Bethesda, MD

## IMPORTANT NOTE
Starting April 17, fluview started reporting death data with a 1 week lag, rather than a 2 week lag. Data from the recent weeks are highly incomplete and should be interpreted with caution

## Abstract

*Background*
Tracking the severity and public health impact of emerging diseases, such as the novel coronavirus diseases COVID-19, is a critical need. These efforts are often hampered by testing issues and reporting lags for key epidemiological data. Evaluating unexplained increases in deaths attributed to non-specific causes, such as pneumonia, can provide a more complete picture of the burden caused by COVID-19. 

*Methods*
We evaluated increases in the occurrence of deaths due to P&I above a seasonal baseline across the United States and compared the rate of excess deaths to reported rates of death due to COVID-19, as well as state-level coronavirus testing rates and excess rates of influenza-like illness. 

*Results*
There were notable increases in the rate of death due to pneumonia and influenza. In a number of states, these increases pre-dated the increase in testing rates and went uncounted. There was substantial variability between states in the discrepancy between reported rates of death due to COVID-19 and the estimated burden of excess deaths due to P&I. In some states, the burden of reported deaths was 10-fold lower than the burden of excess deaths due to P&I. 

*Conclusions*
Given the lack of consistent virological testing, tracking spikes in deaths due to non-specific causes provides the most complete estimate of the burden of COVID-19. This approach provides a framework for tracking the progression of the epidemic and its public health impact. 

## National analysis of P&I
```{r natl_pi_analysis, include=F}
#Run analysis
analysis.data$one <- 1
analysis.data2 <-
    analysis.data[!is.na(analysis.data$total_pni),]
set.seed(123)
excess_ac_natl <-
  excessCases(ds = analysis.data2,
              datevar       = "week_end",
              statevar      = "state",
              adj.flu       = "flu_pct_adj_lag1",
              denom.var     = "nchs.total.deaths",
              use.syndromes = c("nchs.pic"),
              extrapolation.date = extrap.date ,
              sum.dates = count.start.date,
              model.type='negbin',
              time.res='week')
ds <- excess_ac_natl

dates1 <-
  ds[[1]][[1]][[1]]$date
  
sum.pred.iter <-    
  excessExtract(ds = ds,
                syndrome = 'nchs.pic',
                extract.quantity = "sum.pred.iter")

sum.obs <-
    excessExtract(ds = ds,
                syndrome = 'nchs.pic',
                extract.quantity = "sum.obs")

sum.obs.state <- apply(sum.obs,2,sum)

sum.cases.excess <- sapply(1:length(sum.obs.state),
                           function(x){
  sum.obs.state[x] -  sum.pred.iter[,x,1]
  })

sum.excess.deaths.range.pi <-t(
  apply(sum.cases.excess,2,quantile,  probs=c(0.025,0.5,0.975)))

sum.excess.deaths.range.pi <- cbind.data.frame('state'=unique(analysis.data2$state), sum.excess.deaths.range.pi)

res.pi <- format_excess_func(excess_ac_natl,'nchs.pic' )

write.csv(res.pi, './outputs/p_i_natl_obs_expected.csv')

res.pi.nat <- res.pi[res.pi$state=='US',]

sum(res.pi.nat$unexplained.cases[res.pi.nat$mmwr_week>=10 &                              res.pi.nat$mmwr_week<=15 & res.pi.nat$week_end>=as.Date('2020-01-01')])
```

Excess deaths due to pneumonia/influenza/covid nationally in the specified time period
```{r, eval= !params$web.version}
sum.excess.deaths.range.pi <- sum.excess.deaths.range.pi[order(-sum.excess.deaths.range.pi$`50%`),]
print(sum.excess.deaths.range.pi)
```

```{r natl_pi_plot, eval= !params$web.version}

yrange.pneu <- range(c(res.pi.nat$pred, res.pi.nat$obs, res.pi.nat$upi,0))

plot(res.pi.nat$week_end, res.pi.nat$pred, type='l', ylim=yrange.pneu, col='gray',bty='l', ylab='Deaths due to P&I&C', xlab='' )

polygon(c(res.pi.nat$week_end, rev(res.pi.nat$week_end)), c(res.pi.nat$lpi, rev(res.pi.nat$upi)),col = rgb(0, 0, 0, alpha = 0.1), border = NA )

points(res.pi.nat$week_end, res.pi.nat$obs, type='l',  col='red', bty='l')

```

## National analysis of all-cause 

```{r, include=F}

#Run analysis
analysis.data$one <- 1
analysis.data2 <-
    analysis.data[!is.na(analysis.data$total_pni),]

analysis.data$one <- 365000000/100000

set.seed(123)
excess_ac_natl <-
  excessCases(ds = analysis.data2,
              datevar       = "week_end",
              statevar      = "state",
              adj.flu       = "flu_pct_adj_lag1",
              denom.var     = 'one',
              use.syndromes = c("all_deaths"),
              extrapolation.date = extrap.date,
              sum.dates=count.start.date,
              model.type='negbin',
              time.res='week')
ds <- excess_ac_natl

dates1 <-
  ds[[1]][[1]][[1]]$date
  
sum.obs.ac <-
    excessExtract(ds = ds,
                syndrome = 'all_deaths',
                extract.quantity = "sum.obs")

sum.pred.iter.ac <-    
  excessExtract(ds = ds,
                syndrome = 'all_deaths',
                extract.quantity = "sum.pred.iter")

sum.obs.ac2 <- apply(sum.obs.ac,2,sum)
sum.ac.excess <- sapply(1:length(sum.obs.ac2),
                           function(x){
  sum.obs.ac2[x] -  sum.pred.iter.ac[,x,1]
  })

sum.excess.deaths.range.ac <-t(
  apply(sum.ac.excess,2,quantile,  probs=c(0.025,0.1,0.3,0.5,0.975)))

sum.excess.deaths.range.ac <- cbind.data.frame('state'=unique(analysis.data2$state), sum.excess.deaths.range.ac)

res.ac <- format_excess_func(excess_ac_natl,'all_deaths')

res.ac.nat <- res.ac[res.ac$state=='US',]

yrange.pneu <- range(c(res.ac.nat$pred, res.ac.nat$obs, res.ac.nat$upi,0))

sum(res.ac.nat$unexplained.cases[res.ac.nat$mmwr_week>=10  & res.ac.nat$week_end>=as.Date('2020-01-01')])

```

Total excess all cause deaths
```{r}
#print(sum.excess.deaths.range.ac)

nat.range.ac <-sum.excess.deaths.range.ac[sum.excess.deaths.range.ac$state=='US',]

formatted.ac <- 
  paste0(round(nat.range.ac['50%'],-2),
                      '(' ,
                      round(nat.range.ac['2.5%'],-2), ',' ,
                      round(nat.range.ac['97.5%'],-2), ')'
                      )
formatted.ac
nat.range.ac

```
`r if(!params$web.version){print(formatted.ac)}`


```{r plot_ac_natl}
res.ac.nat <- res.ac[res.ac$state=='US',]
plot(res.ac.nat$week_end, res.ac.nat$pred, type='l', ylim=yrange.pneu, col='gray', bty='l', ylab='All-cause Deaths', xlab='')

polygon(c(res.ac.nat$week_end, rev(res.ac.nat$week_end)), c(res.ac.nat$lpi, rev(res.ac.nat$upi)),col = rgb(0, 0, 0, alpha = 0.1), border = NA )

points(res.ac.nat$week_end, res.ac.nat$obs, type='l', col='red', bty='l')
```

```{r summary_table_natl}
res.pi2 <- res.pi
names(res.pi2) <-
  c('year','week','day','week_end_date','state','baseline_pi','baseline_pi_lower', 'baseline_pi_upper', 'pneumonia_influenza_covid','excess_pneumonia_influenza_covid','pic.denom')

res.ac2 <- res.ac
res.ac2$denom <-NULL
names(res.ac2) <-
  c('year','week','day','week_end_date','state','baseline_all_cause','baseline_all_cause_lower', 'baseline_all_cause_upper', 'all_cause_deaths','excess_all_cause_deaths')

res.ac2$week_end_date <- res.ac2$week_end_date + days(6)
res.pi2$week_end_date <- res.pi2$week_end_date + days(6)
comb1 <- merge(res.ac2, res.pi2,
               by=c('state','week_end_date'), all=T)

nchs.covid1<-
  analysis.data2[,c('state','week_end','nchs.covid.deaths')]


comb2 <- merge(comb1,               nchs.covid1,by.x=c('state','week_end_date'), by.y=c('state','week_end'))


test.ds3.spl$week_end_date <- 
  test.ds3.spl$date + days(6)
comb2 <- merge(comb2, test.ds3.spl,
               by=c('state','week_end_date'), all=T)

comb2$covid.track.death[is.na(comb2$covid.track.death)] <- 0

write.csv(comb2,'./outputs/national_and_state_summary.csv' )
```


## Figure 1: Observed weekly death rate vs seasonal baseline (+/-95% Prediction Interval) 
 The black line shows the observed proportion of deaths that were due to Pneumonia & Influenza (P&I) per week. The red line and shaded area represent the 95% Prediction Interval. The latest P&I data is for the week ending `r  max(dates1)+6`.

```{r recast_summary_data}
#recast the summary data as an array
comb2.trim <- comb2
comb2.trim$rr.pic <-
  comb2.trim$pneumonia_influenza_covid/comb2.trim$baseline_pi
comb2.trim$rr.ac <-
  comb2.trim$all_cause_deaths/comb2.trim$baseline_all_cause

comb2.trim <- comb2.trim[!is.na(comb2.trim$week.x),]
comb2.trim$epiweek <- NA
comb2.trim$epiweek[comb2.trim$week.x<=26] <-
  comb2.trim$week.x[comb2.trim$week.x<=26] +26

comb2.trim$epiweek[comb2.trim$week.x>=27] <-
  comb2.trim$week.x[comb2.trim$week.x>=27] -26

comb2.trim$epiyr <- NA
comb2.trim$epiyr <- comb2.trim$year.x
comb2.trim$epiyr[comb2.trim$week.x<=26] <-
  comb2.trim$year.x[comb2.trim$week.x<=26] -1

comb2.trim$week_end_date <-NULL
comb2.trim$date <-NULL

comb2.m <- melt(comb2.trim, id.vars=c('state','epiweek','epiyr'))
comb2.c <- acast(comb2.m, state~epiweek~epiyr~variable )

nat.index <- which(dimnames(comb2.c)[[1]]=='US')
comb2.c <- comb2.c[-nat.index,,,]
```


```{r fig1, fig.width=7.3, fig.height=6.9}
par(mfrow=c(5,4), mar=c(2,4,2,1))
rr <- t(comb2.c[,,'2019','rr.ac'])
rr <- rr[complete.cases(rr),]
plot.state.rank <- cbind.data.frame(state.index=1:dim(rr)[2],state.rank= rank(-rr[dim(rr)[1],]))
plot.state.rank <- plot.state.rank[order(plot.state.rank$state.rank),]
plot.state.indices <- plot.state.rank$state.index

pred <- comb2.c[,,,"baseline_all_cause"  ]
obs <- comb2.c[,,,"all_cause_deaths"  ]
upi <- comb2.c[,,, "baseline_all_cause_upper"]
lpi <- comb2.c[,,,"baseline_all_cause_lower"]


states <- dimnames(comb2.c)[[1]]

  
for(i in plot.state.indices){
    y.range1<-range(c( pred[i,,],obs[i,,], upi[i,,],0), na.rm=T)
    if(states[i] %in% state.abb2 ){
      state.name.plot <-    
      state.name2[match(states[i],state.abb2)]
    }else{
    state.name.plot <- states[i]
  }
  plot( 1:52,
       pred[i,,'2019'],
       type='l',
       col='red',
       ylim=y.range1,
       bty='l',
       xlab='',
       ylab='N deaths',
       xaxt='n'
       )
  
  text(x=1,y=0, state.name.plot,adj=c(0,0),cex=0.9, xpd=NA)

  for(j in 1:dim(obs)[3]){
    points(1:52,
         obs[i,,j],
         type='l',
         col='gray')
  }
  
    points(1:52,
         obs[i,,'2019'],
         type='l',
         col='black')
    
  axis(side=1, at=c(1,14,27,40), labels=c('Jul','Oct','Jan','Apr'))
    
  lpi.miss <- lpi[i,,'2019']
  lpi.miss <- lpi.miss[!is.na(lpi.miss)]
  
  upi.miss <- upi[i,,'2019']
  upi.miss <- upi.miss[!is.na(upi.miss)]
  
  polygon(c(1:length(upi.miss),
            rev(1:length(upi.miss))),
          c(lpi.miss,
            rev(upi.miss)),
          col = rgb(1, 0, 0, alpha = 0.2),
          border = NA)
  }
```


```{r fig2, fig.width=7.3, fig.height=6.9}

par(mfrow=c(5,4), mar=c(2,4,2,1))
rr <- t(comb2.c[,,'2019','rr.pic'])
rr <- rr[complete.cases(rr),]
plot.state.rank <- cbind.data.frame(state.index=1:dim(rr)[2],state.rank= rank(-rr[dim(rr)[1],]))
plot.state.rank <- plot.state.rank[order(plot.state.rank$state.rank),]
plot.state.indices <- plot.state.rank$state.index

pred <- comb2.c[,,,"baseline_pi" ]
obs <- comb2.c[,,,"pneumonia_influenza_covid" ]
denom <- comb2.c[,,,"all_cause_deaths" ]
upi <- comb2.c[,,,"baseline_pi_upper" ]
lpi <- comb2.c[,,,"baseline_pi_lower" ]


states <- dimnames(comb2.c)[[1]]

  
for(i in plot.state.indices){
    y.range1<-range(c( pred[i,,]/denom[i,,],obs[i,,]/denom[i,,], upi[i,,]/denom[i,,] ,0), na.rm=T)
    if(states[i] %in% state.abb2 ){
      state.name.plot <-    
      state.name2[match(states[i],state.abb2)]
    }else{
    state.name.plot <- states[i]
  }
  plot( 1:52,
       pred[i,,'2019']/denom[i,,'2019'],
       type='l',
       col='red',
       ylim=y.range1,
       bty='l',
       xlab='',
       ylab='Proportion',
       xaxt='n'
       )
  
  text(x=1,y=y.range1[2], state.name.plot, pos=4,cex=0.9, xpd=NA)

  for(j in 1:dim(obs)[3]){
    points(1:52,
         obs[i,,j]/denom[i,,j],
         type='l',
         col='gray')
  }
  
    points(1:52,
         obs[i,,'2019']/denom[i,,'2019'],
         type='l',
         col='black')
    
  axis(side=1, at=c(1,14,27,40), labels=c('Jul','Oct','Jan','Apr'))
    
  lpi.miss <- lpi[i,,'2019']
  lpi.miss <- lpi.miss[!is.na(lpi.miss)]
  
  upi.miss <- upi[i,,'2019']
  upi.miss <- upi.miss[!is.na(upi.miss)]
  
  denom.miss <- denom[i,,'2019']
  denom.miss <- denom.miss[!is.na(denom.miss)]
  polygon(c(1:length(upi.miss),
            rev(1:length(upi.miss))),
          c(lpi.miss/denom.miss,
            rev(upi.miss/denom.miss)),
          col = rgb(1, 0, 0, alpha = 0.2),
          border = NA)
  }
```


## Figure 3: Reported number of COVID-19 deaths,compared with the excess deaths due to pneumonia and influenza in each week, by state. 
The red line shows the number of excess P&I cases +/-95% prediction intervals. The blue solid line shows the reported number of COVID-19 deaths for the same week (as compiled by covidtracking.com), and the dotted blue line shows the reported COVID-19 deaths for weeks in which the CDC data were not yet reliable. The grey dashed line represents number of tests performed per-capita in that week. 

```{r}

jh3 <- comb2
#Only plot out to 1 week ahead of the US P&I data
jh3 <- jh3[ jh3$week_end_date <= end.data.date +weeks(1),]
jh3 <- jh3[jh3$state %in% states.cdc,]
#jh3 <-jh3[!is.na(jh3$excess_pi ),]


jh3<-jh3[jh3$week_end_date >=as.Date('2020-02-01'),]

jh3 <- jh3[!is.na(jh3$week_end_date),]
```

```{r fig3, fig.width=7.3, fig.height=6.9}
## uses NCHS covid deaths for reported deaths

  par(mfrow=c(5,4), mar=c(2,4,3,1), oma = c(3,3,0,3) + 0.1)
ts.plot.func(ds.plot=jh3,   states.plot=unique(jh3$state),ylim.adj=15.0 ,death.var="nchs.covid.deaths" )

title(xlab = "Date",
      ylab = "N Deaths",
      outer = TRUE, line = 1, cex=1.0)
   mtext(text="Tests/1000 people", line=2,side=4,outer=TRUE, cex=0.75, col='gray')

```

## Table 1: Excess P&I deaths and reported deaths due to COVID-19

```{r, table1}
nchs.tot.deaths <- aggregate(comb2[comb2$week_end_date>=count.start.date & comb2$week_end_date<=end.data.date,                           c('nchs.covid.deaths','covid.track.death')], by=list('state'=comb2$state[comb2$week_end_date>=count.start.date & comb2$week_end_date<=end.data.date]), FUN=sum, na.rm=T)

formatted.excess.ac <- 
  paste0(round(sum.excess.deaths.range.ac[,'50%'],-2),
                      '(' ,
                      round(sum.excess.deaths.range.ac[,'2.5%'],-2), ',' ,
                      round(sum.excess.deaths.range.ac[,'97.5%'],-2), ')'
                      )
formatted.excess.ac <- cbind.data.frame('state'=sum.excess.deaths.range.ac$state,formatted.excess.ac)


formatted.excess.pic <- 
  paste0(round(sum.excess.deaths.range.pi[,'50%'],-1),
                      '(' ,
                      round(sum.excess.deaths.range.pi[,'2.5%'],-1), ',' ,
                      round(sum.excess.deaths.range.pi[,'97.5%'],-1), ')'
                      )
formatted.excess.pic <- cbind.data.frame('state'=sum.excess.deaths.range.pi$state, 'Excess P&I&C'= formatted.excess.pic)

sum.excess.deaths.range.ac.inc <- merge(sum.excess.deaths.range.ac, pop2, by='state', all=T)

formatted.excess.ac.INC <- 
  paste0(round(sum.excess.deaths.range.ac.inc[,'50%']/sum.excess.deaths.range.ac.inc[,'census_bureau_pop_2019']*100000,1),
                      '(' ,
                      round(sum.excess.deaths.range.ac.inc[,'2.5%']/sum.excess.deaths.range.ac.inc[,'census_bureau_pop_2019']*100000,1), ',' ,
                      round(sum.excess.deaths.range.ac.inc[,'97.5%']/sum.excess.deaths.range.ac.inc[,'census_bureau_pop_2019']*100000,1), ')'
                      )
formatted.excess.ac.INC <- cbind.data.frame('state'=sum.excess.deaths.range.ac.inc$state, 'Excess all-cause deaths/100,000'= formatted.excess.ac.INC, "excess.inc.raw"=sum.excess.deaths.range.ac.inc[,'50%']/sum.excess.deaths.range.ac.inc[,'census_bureau_pop_2019']*100000)

excess.combined <-
  merge(formatted.excess.pic,formatted.excess.ac.INC, by='state')

excess.combined <- merge(formatted.excess.ac, excess.combined,by='state')

excess.combined <- merge(nchs.tot.deaths, excess.combined,by='state')

#excess.combined

#sort by incidence
excess.combined <- excess.combined[rev(order(excess.combined$excess.inc.raw)),]

excess.combined2 <- excess.combined[,c('state','nchs.covid.deaths',"Excess P&I&C" ,"formatted.excess.ac" ,"Excess all-cause deaths/100,000")]

names(excess.combined2) <- c('State','COVID-19 deaths (U07.1)', 'Excess Pneumonia/Influenza/Covid-19 deaths', 'Excess all-cause deaths', 'Excess all-cause deaths/100,000')

htmlTable(excess.combined2, caption=paste0('Observed and Excess deaths due to COVID-19, pneumonia/influenza/Covid-19, and all-causes COVID-19, from March 1, 2020 through ', last.date.format), rnames=F)
```




## Figure 4: Compare Excess P&I mortality vs Excess ILI

Here we compare the observed vs expected number of deaths due to pneumonia and influenza in each week compare to the observed vs expected number of outpatient visits for influenza-like illness (ILI) in each week. we would expect ILI (blue line) to increase earlier than deaths (red line)

```{r, include=F}
#ARCHIVE
ili.data <- runIfExpired('ilinet_state', ~ilinet(region = c("state")))
ili.data$state <- state.abb2[match(ili.data$region, state.name2)]
ili.data       <- ili.data[, c("state", "week_start", "ilitotal", "total_patients")]
ili.data       <- ili.data[!is.na(ili.data$total_patients),]
ili.data.spl   <- split(ili.data, ili.data$state)

min<-sapply(ili.data.spl, function(x)  min(x$total_patients))

state.select<-names(min)[which(min>0) ]
ili.data <- ili.data[ili.data$state %in% state.select,]
## Run the main analysis function, adjusting for flu using NREVSS data

ili.data2 <- merge(ili.data, hhs_states.cw, by='state')
ili.data2.agg <- aggregate(ili.data2[,c('ilitotal','total_patients')], by=list('state'=ili.data2$state_region,"week_start"=ili.data2$week_start), FUN=sum)

ili.data2.agg <- merge(ili.data2.agg, clin4.lags, by.x=c('state','week_start'), by.y=c('state', 'wk_date'))

set.seed(123)
excess_cases1 <-
  excessCases(ds = ili.data2.agg,
              datevar       = "week_start", 
              statevar      = "state",
              denom.var     = "total_patients",
              adj.flu       = "flu_pct_adj",
              use.syndromes = c("ilitotal"),
              extrapolation.date = "2020-03-01",
              time.res='week')

dates.ili <-
  excess_cases1[[1]][[1]][[1]]$date
  
rr.ili <-  excessExtract(ds = excess_cases1,
                syndrome = "ilitotal",
                extract.quantity = "resid1")

date.mmwrdates.ili <- mmwr_week(dates.ili)
mmwr.epiyr.ili<- date.mmwrdates.ili$mmwr_year
mmwr.epiyr.ili[date.mmwrdates.ili$mmwr_week<=26] <- mmwr.epiyr.ili[date.mmwrdates.ili$mmwr_week<=26] - 1

mmwr.epiwk.ili <- date.mmwrdates.ili$mmwr_week
mmwr.epiwk.ili[date.mmwrdates.ili$mmwr_week>=27]<-date.mmwrdates.ili$mmwr_week[date.mmwrdates.ili$mmwr_week>=27] - 52
mmwr.epiwk.ili <- mmwr.epiwk.ili +26

rr.ili2 <- rr.ili[mmwr.epiyr.ili==2019,,1]
```

```{r}
rr.state.pic <- t(comb2.c[,,'2019','rr.pic'])
rr.state.ac <- t(comb2.c[,,'2019','rr.ac'])

```


```{r fig4, fig.width=7.3, fig.height=7}
common.states <- 
  intersect(colnames(rr.state.pic), colnames(rr2.ili) )

n.nonmiss <- sum(!is.na(rr.common.states[,1]))
rr.common.states <- rr.state.pic[,common.states]
rr2.comp <-rr.common.states
rr2.ili.comp <- rr.ili2[,common.states]
plot.state.rank <-
  cbind.data.frame(state.index=1:dim(rr.common.states)[2],state.rank= rank(-rr.common.states[n.nonmiss,]))

plot.state.rank <-
  plot.state.rank[order(plot.state.rank$state.rank),]
  plot.state.indices <- plot.state.rank$state.index
  
dates1 <- unique(comb2[,c("week_end_date" ,'year.x','week.x')])

dates.plot4 <- seq.Date(from=dates1$week_end_date[dates1$year.x==2019 & dates1$week.x==27][1], length.out=52, by='week')


par(mfrow=c(5,4), mar=c(2,4,2,2))

for(i in plot.state.indices){
    y.range1<-c(0,5)
    if(dimnames(rr.common.states)[[2]][i] %in% state.abb2 ){
      state.name.plot <-    
      state.name2[match(dimnames(rr.common.states)[[2]][i],state.abb2)]
    }else{
    state.name.plot <- dimnames(rr.common.states)[[2]][i]
    }
    
    plot(dates.plot4         ,
       rr2.comp[,i],
       type='l',
       col='#e41a1c',
       ylim=y.range1,
       xlim=c(as.Date(c('2019-07-01')),max(pi.data$week_end)),
       bty='l',
       lty=1,
       xlab='',
       xaxt='n',
       ylab='Observed/Expected'
       #main=common.states[i]
       )
    axis(1, at=as.Date(c('2019-07-01', '2019-10-01','2020-01-01', '2020-04-01', '2020-07-01')) , labels= c('Jul','Oct','Jan','Apr','')  )

      points(dates.plot4[1:nrow(rr2.ili.comp)]         ,
       exp(rr2.ili.comp[,i]), type='l', col='#377eb8')
    abline(h=1, col='gray', lty=2)
    
    text(min(dates.plot4), y=0.2, state.name.plot,pos=4, cex=0.9, offset=0.1, xpd=NA)


}

```

```{r, eval=F}

#CHANGEPOINTS for excess ILI and excess P&I
cp.ds <- function(ds){
  spl<-matrix(NA, ncol=length(ds), nrow=length(ds))
  #Create the splines
for(i in 1:length(ds)){
  spl[,i]<- (1:length(ds)) -i
  spl[,i][spl[,i]<0]<-0
}
  aics<- rep(NA, ncol(spl))
  for(i in 1:ncol(spl)){
  mod1<- glm(ds ~ spl[,i] )
  aics[i]<-AIC(mod1)
  cp.date.index <- which(min(aics)==aics)
  }
  best.aic<-min(aics)
  w.aic<- exp(-0.5*(aics-best.aic))/sum(exp(-0.5*(aics-best.aic)))
  results <- list('w.aics'=w.aic,'cp.date.index'=cp.date.index )
  return(results)
} 
cp.ili <- apply(rr2.ili.comp[225:nrow(rr2.ili.comp),],2,cp.ds)
cp.ili.waics <- round(sapply(cp.ili,'[[', 'w.aics'),2)
cp.pi  <- apply(rr2.comp[225:nrow(rr2.comp),],2,cp.ds)
cp.pi.waics <- round(sapply(cp.pi,'[[', 'w.aics'),2)

#NOTE:: INDEX FOR ILI AND INDEX FOR PI are different--more week for ILI..need to convert back to DATE
#plot(cp.ili, cp.pi)

```



## Table S1: Excess deaths by week across the US, compared with provisional death counts from NCHS
Note excess P&I deaths numbers do not include Connecticut, North Carolina, and West Virginia. Combining together the exces P&I and COIVD-19 deaths without pneumonia diagnoses gives an estimate for number of deaths   
```{r}
count.excess <-jh3[jh3$date >= as.Date(count.start.date) & jh3$date <= max(pi.data$week_end) ,]

count.excess$excess_pi_adj <- count.excess$excess_pi

count.excess$total_pi_adj <- count.excess$total_pi

count.excess$excess_pi_var_ADJ <- count.excess$excess_pi_var

count.excess2 <- aggregate(count.excess[,c('excess_pi_adj','total_pi_adj',"nchs.covid.deaths","covid.track.death" ,'excess_pi_var_ADJ')], by=list('date'=count.excess$date) ,FUN=sum)

count.excess2$exces_ci_ucl <- round(count.excess2$excess_pi_adj + 1.96*sqrt(count.excess2$excess_pi_var_ADJ))

count.excess2$exces_ci_lcl <- round(count.excess2$excess_pi_adj - 1.96*sqrt(count.excess2$excess_pi_var_ADJ))


count.excess2$excess_pi_ci <- paste0(round(count.excess2$excess_pi_adj), '(',  count.excess2$exces_ci_lcl, ', ', count.excess2$exces_ci_ucl,')'  ) 

#sort by incidence
count.excess2 <- count.excess2[(order(count.excess2$date)),]

count.excess2$total_pi_adj <- round(count.excess2$total_pi_adj)

count.excess2$wk.end <-count.excess2$date+6

count.excess3 <- count.excess2[, c('wk.end','total_pi_adj','excess_pi_ci' ,"nchs.covid.deaths","covid.track.death" )]

names(count.excess3) <-c('Week ending','Total P&I deaths', 'Excess P&I&C deaths', 'Covid-19 Deaths NCHS','All reported COVID-19 deaths (covidtracking.com)')
last.date.format<-max(pi.data$week_end)
last.date.format<-format(last.date.format,
                         "%b %d, %Y")

count.excess4 <- count.excess3

htmlTable(count.excess4, caption=paste0('Table S1: Comparison of data sources: Observed and Excess deaths due to pneumonia & influenza, and COVID-19, from January 26, 2020 through ', last.date.format), rnames=F)
```



```{r, eval=F}
#Just NY
par(mfrow=c(1,2))
  plot.state.indices <- which(dimnames(pred.ac)[[2]] %in% c('NY','NYC') )
for(i in plot.state.indices){
  for(j in 1:dim(pred.ac)[3]){
    y.range1<-range(c( pred.ac[select.indices,i,j],obs.ac[select.indices,i,j], upi.ac[select.indices,i,j],0))
  plot(dates1.ac[select.indices],
       pred.ac[select.indices,i,j]/denom.ac[select.indices,i,j],
       type='l',
       col='red',
       ylim=c(0,3000),
       bty='l',
       ylab='Number',
       main=paste(states.ac[i],ages[j]))

  points(dates1.ac[select.indices],
         obs.ac[select.indices,i,j],
         type='l',
         col='black')

  polygon(c(dates1.ac[select.indices],
            rev(dates1.ac[select.indices])),
          c(lpi.ac[select.indices,i,j],
            rev(upi.ac[select.indices,i,j])),
          col = rgb(1, 0, 0, alpha = 0.1),
          border = NA)
  }
}
```


## Figure S2: Excess all-cause deaths for NY state (incl NYC) vs Excess deaths due to pneumonia and influenza

```{r fig.s2, fig.width=8, fig.height=6}
par(mfrow=c(2,2), mar=c(3,4,2,1))

for(i in c('NY','NJ','CA','MA')){
excess.ny.pic <- comb2.c[i,,'2019',"excess_pneumonia_influenza_covid"  ]
excess.ny.ac <- comb2.c[i,,'2019',"excess_all_cause_deaths" ]

n.nonmiss <- sum(!is.na(covid.ny))

covid.ny <- comb2.c[i,,'2019',"nchs.covid.deaths" ]
plot(1:n.nonmiss,excess.ny.ac[1:n.nonmiss], type='l', bty='l', ylab='Excess deaths (N)', main=i, xaxt='n')
axis(side=1, at=c(1,14,27,40), label=c('Jul','Oct','Jan', 'Apr'))
points(1:n.nonmiss,excess.ny.pic[1:n.nonmiss], type='l', col='red')
#points(1:52, report.ny$covid.track.death, col='blue', type='l', lty=2)
points(1:n.nonmiss,covid.ny[1:n.nonmiss], col='blue', type='l', lty=3)
 legend(1, 6000, legend=c("Excess all-cause deaths",   "Excess P&I deaths",'NCHS COVID-19 deaths'),
       col=c("black", "red", 'blue'), lty=c(1,1,2,3), cex=0.8) 
 print(excess.ny.ac[n.nonmiss]/covid.ny[n.nonmiss])
}

```


 
## Figure S3: NYC only data P&I&C vs all-cause excess deaths
```{r nyc}
nyc.data <- cdc.data.ny.separate[cdc.data.ny.separate$state=='NYC',]

nyc.data$one <- 1

nyc.data$nchs.pic[nyc.data$week_end<as.Date('2020-02-01')] <-nyc.data$total_pni[nyc.data$week_end<as.Date('2020-02-01')]

nyc.data$nchs.total.deaths[nyc.data$week_end<as.Date('2020-02-01')] <-nyc.data$all_deaths[nyc.data$week_end<as.Date('2020-02-01')]

nyc.data <- nyc.data[!is.na(nyc.data$nchs.total.deaths),]
nyc.data$state <-'NYC'

set.seed(123)
nyc.pi <-
  excessCases(ds = nyc.data,
              datevar       = "week_end",
              statevar      = "state",
              denom.var     = "nchs.total.deaths",
              adj.flu       = "none",
              use.syndromes = c("nchs.pic"),
              extrapolation.date = '2020-01-26',
              time.res='week')
set.seed(123)
nyc.acm <-
  excessCases(ds = nyc.data,
              datevar       = "week_end",
              statevar      = "state",
              denom.var     = "one",
              adj.flu       = "none",
              use.syndromes = c("nchs.total.deaths"),
              extrapolation.date = '2020-01-26',
              time.res='week')

nyc.excess.pi <-  excessExtract(ds = 
                nyc.pi,
                syndrome = "nchs.pic",
                extract.quantity = "unexplained.cases")
nyc.excess.acm <-  excessExtract(ds = 
                nyc.acm,
                syndrome = "nchs.total.deaths",
                extract.quantity = "unexplained.cases")

dates.select<- which(nyc.data$week_end>=as.Date('2020-02-01'))
dates2 <- nyc.data$week_end
plot(dates2[dates.select],nyc.excess.acm[dates.select,1,1], type='l', bty='l', ylab='Excess deaths (N)', main='New York City')
points(dates2[dates.select],nyc.excess.pi[dates.select,1,1], type='l', col='red')
legend(as.Date('2016-01-01'), 300, legend=c("Excess all-cause deaths", "Excess P&I&C deaths"),
       col=c("black", "red"), lty=1, cex=0.8)

```
Ratio of all-cause vs P&I deaths in NYC. In NYC, only 25% of excess deaths were coded as P&I
```{r}
dates.select2 <- dates.select<- which(nyc.data$week_end>=as.Date('2020-03-15'))
 
nyc.excess.pi[dates.select2,1,1]/nyc.excess.acm[dates.select2,1,1]


```



## Table S3: Do not adjust for flu

```{r, include=F} 
#Run analysis 
set.seed(123)
excess_deaths1.unadjusted <-
  excessCases(ds = analysis.data2,
              datevar       = "week_end",
              statevar      = "state",
              adj.flu       = "none",
              denom.var     = "nchs.total.deaths",
              use.syndromes = c("nchs.pic"),
              extrapolation.date = extrap.date ,
              sum.dates = count.start.date,
              model.type='negbin',
              time.res='week')
```
 
```{r}
#Extract the data needed to plot from the results
ds <- excess_deaths1.unadjusted

sum.pred.iter.unadj <-    
  excessExtract(ds = ds,
                syndrome = 'nchs.pic',
                extract.quantity = "sum.pred.iter")

sum.obs.unadj <-
    excessExtract(ds = ds,
                syndrome = 'nchs.pic',
                extract.quantity = "sum.obs")

sum.obs.state.unadj <- apply(sum.obs.unadj,2,sum)

sum.cases.excess.unadj <- sapply(1:length(sum.obs.state.unadj),
                           function(x){
  sum.obs.state.unadj[x] -  sum.pred.iter.unadj[,x,1]
  })

sum.excess.deaths.range.pi.unadj <-t(
  apply(sum.cases.excess.unadj,2,quantile,  probs=c(0.025,0.5,0.975)))

sum.excess.deaths.range.pi.unadj <- cbind.data.frame('state'=unique(analysis.data2$state), sum.excess.deaths.range.pi.unadj)

formatted.pic.unadj <- 
  paste0(round(sum.excess.deaths.range.pi.unadj[,'50%'],-1),
                      '(' ,
                      round(sum.excess.deaths.range.pi.unadj[,'2.5%'],-1), ',' ,
                      round(sum.excess.deaths.range.pi.unadj[,'97.5%'],-1), ')'
                      )
formatted.pic.unadj <- cbind.data.frame('state'=sum.excess.deaths.range.pi.unadj$state,formatted.pic.unadj)

formatted.pic.adj <- 
  paste0(round(sum.excess.deaths.range.pi[,'50%'],-1),
                      '(' ,
                      round(sum.excess.deaths.range.pi[,'2.5%'],-1), ',' ,
                      round(sum.excess.deaths.range.pi[,'97.5%'],-1), ')'
                      )

formatted.pic.adj <- cbind.data.frame('state'=sum.excess.deaths.range.pi$state,formatted.pic.adj)

summary.table.adj.unadj <- merge(formatted.pic.adj,formatted.pic.unadj, by='state')

names(summary.table.adj.unadj) <- c('State', 'Excess P&I&C, adjusted for influenza','Excess P&I&C, unadjusted for influenza')
htmlTable(summary.table.adj.unadj)

```
