---
title: "us P&I mortality"
author: "Dan Weinberger"
date: "4/2/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Install package
```{r}
if (!require("devtools")) {
  install.packages("devtools")
}
#devtools::install_github("weinbergerlab/ExcessILI")
```

```{r}
library(ExcessILI)
library(cdcfluview)
```

## Download the mortality data

```{r}
pi.data <- pi_mortality(coverage_area='state')

```

Format and subset
```{r}
pi.data$state <- state.abb[match(pi.data$region_name, state.name)]
pi.data$state[pi.data$region_name == 'New York City'] <- 'NYC'

#pi.data.subset <- pi.data[pi.data$state %in% c('AL','AZ','CA','CO','FL','GA','IL','IN','LA','MD','MA','MI','MN','MO','NV','NJ','NY','NC','OH','PA','SC','TN','TX','VA','WA','WI'),]

pi.data.subset <- as.data.frame(pi.data[pi.data$state %in% c('AZ','CA','FL','GA','IL','LA','MI','MN','NJ','NY','OH','PA','TX','VA','WA','WI'),])
pi.data.subset <-pi.data.subset[order(pi.data.subset$state, pi.data.subset$wk_start),]
```

```{r}
excess_deaths1.adjusted <-
  excessCases(ds = pi.data.subset,
              datevar       = "wk_start",
              statevar      = "state",
              denom.var     = "all_deaths",
              adj.flu       = "auto",
              use.syndromes = c("total_pni"),
              extrapolation.date = "2020-03-01",
              time.res='week')
```


```{r, echo=T}
 dashboardPlot(excess_deaths1.adjusted)
```


## Generate static versions of the plots

### Extract the quantities of interest

Which syndrome do you want to plot, and over what time range?
```{r}
syndrome.select <- 'total_pni' #which syndrome do you want to plot?
n.days<-52  #How many days to plot?
ds <- excess_deaths1.adjusted
```
 
Extract the data needed to plot from the results
```{r}

dates1 <-
  ds[[1]][[1]][[1]]$date
  
unexplained.cases <-
  excessExtract(ds = ds,
                syndrome = syndrome.select,
                extract.quantity = "unexplained.cases")

unexplained.log.rr <-
  excessExtract(ds = ds,
                syndrome = syndrome.select,
                extract.quantity = "resid1")

denom <-
  excessExtract(ds = ds,
                syndrome = syndrome.select,
                extract.quantity = "denom")


upi <-
  excessExtract(ds = ds,
                syndrome = syndrome.select,
                extract.quantity = "upi")

lpi <-
  excessExtract(ds = ds,
                syndrome = syndrome.select,
                extract.quantity = "lpi")

obs <-
  excessExtract(ds = ds,
                syndrome = syndrome.select,
                extract.quantity = "y")

pred<-  excessExtract(ds = ds,
                syndrome = syndrome.select,
                extract.quantity = "pred")

```

Generate the plots
```{r, fig.width=8, fig.height=7}

select.indices <- (length(dates1)-n.days):length(dates1)
dates<-dates1[select.indices]
states <- dimnames(pred)[[2]]
ages <- dimnames(pred)[[3]]

  par(mfrow=c(4,4))

for(i in 1:dim(pred)[2]){
  for(j in 1:dim(pred)[3]){
    y.range1<-range(c( pred[select.indices,i,j]/denom[select.indices,i,j],obs[select.indices,i,j]/denom[select.indices,i,j], upi[select.indices,i,j]/denom[select.indices,i,j],0))
  plot(dates,
       pred[select.indices,i,j]/denom[select.indices,i,j],
       type='l',
       col='red',
       ylim=y.range1,
       bty='l',
       ylab='Proportion',
       main=paste(states[i],ages[j]))

  points(dates,
         obs[select.indices,i,j]/denom[select.indices,i,j],
         type='l',
         col='black')

  polygon(c(dates,
            rev(dates)),
          c(lpi[select.indices,i,j]/denom[select.indices,i,j],
            rev(upi[select.indices,i,j]/denom[select.indices,i,j])),
          col = rgb(1, 0, 0, alpha = 0.1),
          border = NA)
  }
}
```
